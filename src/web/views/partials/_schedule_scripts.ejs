<script>
  // Function to format time in 12-hour format with AM/PM
  function formatTime(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    const period = hours >= 12 ? "PM" : "AM";
    const displayHours = hours % 12 || 12;
    return `${displayHours}:${mins.toString().padStart(2, "0")} ${period}`;
  }

  // Function to generate PDF
  function generatePDF() {
    const doc = new jsPDF();
    let y = 20;

    // Add title
    doc.setFontSize(16);
    doc.text("FLL Competition Schedule", 105, y, { align: "center" });
    y += 20;

    // Get schedule data from server
    const judgingSchedule = <%- JSON.stringify(schedule.judgingSchedule) %>;
    const tableRuns = <%- JSON.stringify(schedule.tableRuns) %>;
    const teamsSchedule = <%- JSON.stringify(schedule.teamsSchedule) %>;

    // Add Judging Schedule
    doc.setFontSize(14);
    doc.text("Judging Schedule", 14, y);
    y += 10;

    doc.setFontSize(10);
    judgingSchedule.forEach((room, roomIndex) => {
      if (room.length > 0) {
        doc.text(`Room ${roomIndex + 1}:`, 14, y);
        y += 7;
        room.forEach((event) => {
          const timeStr = formatTime(event.startTime);
          doc.text(
            `${timeStr} - ${event.teamName} (#${
              event.teamNumber || event.teamID
            })`,
            20,
            y
          );
          y += 7;
        });
        y += 5;
      }
    });

    // Add Robot Game Schedule
    y += 10;
    doc.setFontSize(14);
    doc.text("Robot Game Schedule", 14, y);
    y += 10;

    doc.setFontSize(10);
    tableRuns.forEach((table, tableIndex) => {
      if (table.length > 0) {
        doc.text(`Table ${tableIndex + 1}:`, 14, y);
        y += 7;
        table.forEach((event) => {
          const timeStr = formatTime(event.startTime);
          doc.text(
            `${timeStr} - ${event.teamName} (#${
              event.teamNumber || event.teamID
            })`,
            20,
            y
          );
          y += 7;
        });
        y += 5;
      }
    });

    // Add Team Schedules
    y += 10;
    doc.setFontSize(14);
    doc.text("Team Schedules", 14, y);
    y += 10;

    doc.setFontSize(10);
    teamsSchedule.forEach((teamEvents, teamIndex) => {
      if (teamIndex > 0 && teamEvents.length > 0) {
        doc.text(
          `Team ${teamIndex}: ${teamEvents[0].teamName} (#${
            teamEvents[0].teamNumber || teamIndex
          })`,
          14,
          y
        );
        y += 7;
        teamEvents.forEach((event) => {
          const timeStr = formatTime(event.startTime);
          let eventType = "";
          if (event.type === "tableRun") {
            eventType = "Robot Game";
          } else if (event.type === "robotJudging") {
            eventType = "Robot Design Judging";
          } else if (event.type === "projectJudging") {
            eventType = "Project Judging";
          }
          doc.text(`${timeStr} - ${eventType} at ${event.locationName}`, 20, y);
          y += 7;
        });
        y += 5;
      }
    });

    // Save the PDF
    doc.save("fll-schedule.pdf");
  }

  // Initialize schedule data from server
  const scheduleData = {
    events: JSON.parse(
      "<%- JSON.stringify(schedule.teamsSchedule.flatMap(function(team, teamIndex) { return team.map(function(event) { return { teamId: teamIndex, teamName: event.teamName, startTime: event.startTime, type: event.type, location: event.locationName, duration: event.duration }; }); }).filter(Boolean)) %>"
    ),
  };

  // Populate upcoming events
  function updateUpcomingEvents() {
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();

    const upcomingEvents = scheduleData.events
      .filter((event) => event.startTime >= currentMinutes)
      .sort((a, b) => a.startTime - b.startTime)
      .slice(0, 5);

    const upcomingEventsHtml = upcomingEvents
      .map(
        (event) =>
          '<div class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm">' +
          "<div>" +
          '<p class="font-medium">' +
          '<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-1 text-xs">#' +
          event.teamId +
          "</span>" +
          event.teamName +
          "</p>" +
          '<p class="text-sm text-gray-500">' +
          (event.type === "tableRun"
            ? "Robot Game"
            : event.type === "robotJudging"
            ? "Robot Design"
            : "Project") +
          " at " +
          event.location +
          "</p>" +
          "</div>" +
          '<div class="text-right">' +
          '<p class="text-sm font-medium">' +
          formatTime(event.startTime) +
          "</p>" +
          "</div>" +
          "</div>"
      )
      .join("");

    document.getElementById("upcoming-events").innerHTML =
      upcomingEventsHtml ||
      '<p class="text-gray-500 text-center p-3">No upcoming events</p>';
  }

  // Update upcoming events every minute
  updateUpcomingEvents();
  setInterval(updateUpcomingEvents, 60000);

  // Populate schedule statistics
  function updateScheduleStats() {
    const stats = scheduleData.events.reduce(
      (acc, event) => ({
        totalEvents: acc.totalEvents + 1,
        robotGames: acc.robotGames + (event.type === "tableRun" ? 1 : 0),
        judgingSessions:
          acc.judgingSessions + (event.type !== "tableRun" ? 1 : 0),
        averageEventDuration: acc.averageEventDuration + event.duration,
      }),
      {
        totalEvents: 0,
        robotGames: 0,
        judgingSessions: 0,
        averageEventDuration: 0,
      }
    );

    stats.averageEventDuration = Math.round(
      stats.averageEventDuration / stats.totalEvents
    );

    document.getElementById("schedule-stats").innerHTML =
      '<div class="grid grid-cols-2 gap-4">' +
      '<div class="bg-white p-4 rounded-lg shadow-sm">' +
      '<p class="text-sm text-gray-500">Total Events</p>' +
      '<p class="text-2xl font-bold">' +
      stats.totalEvents +
      "</p>" +
      "</div>" +
      '<div class="bg-white p-4 rounded-lg shadow-sm">' +
      '<p class="text-sm text-gray-500">Robot Games</p>' +
      '<p class="text-2xl font-bold">' +
      stats.robotGames +
      "</p>" +
      "</div>" +
      '<div class="bg-white p-4 rounded-lg shadow-sm">' +
      '<p class="text-sm text-gray-500">Judging Sessions</p>' +
      '<p class="text-2xl font-bold">' +
      stats.judgingSessions +
      "</p>" +
      "</div>" +
      '<div class="bg-white p-4 rounded-lg shadow-sm">' +
      '<p class="text-sm text-gray-500">Avg Duration</p>' +
      '<p class="text-2xl font-bold">' +
      stats.averageEventDuration +
      " min</p>" +
      "</div>" +
      "</div>";
  }

  updateScheduleStats();

  // Export to Google Sheets functions

  // Direct export handlers for the buttons
  window.exportJudgingSchedule = function() {
    const judgingSchedule = <%- JSON.stringify(schedule.judgingSchedule) %>;
    const data = [];

    judgingSchedule.forEach((room, roomIndex) => {
      room.forEach(event => {
        data.push({
          room: `Room ${roomIndex + 1}`,
          time: formatTime(event.startTime),
          team: event.teamName,
          teamNumber: event.teamNumber || event.teamID,
          type: event.type === 'robotJudging' ? 'Robot Design' : 'Project',
          duration: `${event.duration} min`
        });
      });
    });

    downloadCSV(data, 'FLL_Judging_Schedule');
  };

  window.exportTableSchedule = function() {
    const tableRuns = <%- JSON.stringify(schedule.tableRuns) %>;
    const data = [];

    tableRuns.forEach((table, tableIndex) => {
      table.forEach(event => {
        data.push({
          table: `Table ${tableIndex + 1}`,
          time: formatTime(event.startTime),
          team: event.teamName,
          teamNumber: event.teamNumber || event.teamID,
          type: 'Robot Game',
          duration: `${event.duration} min`
        });
      });
    });

    downloadCSV(data, 'FLL_Table_Schedule');
  };

  window.exportTeamSchedule = function() {
    const teamsSchedule = <%- JSON.stringify(schedule.teamsSchedule) %>;
    const data = [];

    teamsSchedule.forEach((events, teamIndex) => {
      if (teamIndex === 0) return; // Skip index 0 as it's empty

      events.forEach(event => {
        let eventType = '';
        if (event.type === 'tableRun') eventType = 'Robot Game';
        else if (event.type === 'projectJudging') eventType = 'Project';
        else if (event.type === 'robotJudging') eventType = 'Robot Design';

        data.push({
          team: `Team ${teamIndex}`,
          teamName: event.teamName,
          teamNumber: event.teamNumber || event.teamID,
          time: formatTime(event.startTime),
          eventType: eventType,
          location: event.locationName,
          duration: `${event.duration} min`
        });
      });
    });

    downloadCSV(data, 'FLL_Team_Schedule');
  };

  window.exportFullSchedule = function() {
    const teamsSchedule = <%- JSON.stringify(schedule.teamsSchedule) %>;
    const judgingSchedule = <%- JSON.stringify(schedule.judgingSchedule) %>;
    const tableRuns = <%- JSON.stringify(schedule.tableRuns) %>;
    const data = [];

    // Add judging schedule data
    judgingSchedule.forEach((room, roomIndex) => {
      room.forEach(event => {
        data.push({
          section: 'Judging',
          location: `Room ${roomIndex + 1}`,
          team: event.teamName,
          teamNumber: event.teamNumber || event.teamID,
          time: formatTime(event.startTime),
          eventType: event.type === 'robotJudging' ? 'Robot Design' : 'Project',
          duration: `${event.duration} min`
        });
      });
    });

    // Add table runs data
    tableRuns.forEach((table, tableIndex) => {
      table.forEach(event => {
        data.push({
          section: 'Robot Game',
          location: `Table ${tableIndex + 1}`,
          team: event.teamName,
          teamNumber: event.teamNumber || event.teamID,
          time: formatTime(event.startTime),
          eventType: 'Robot Game',
          duration: `${event.duration} min`
        });
      });
    });

    // Sort by time
    data.sort((a, b) => {
      const timeA = a.time;
      const timeB = b.time;
      return timeA.localeCompare(timeB);
    });

    downloadCSV(data, 'FLL_Complete_Schedule');
  };

  // Helper function to download CSV
  function downloadCSV(dataArray, filename) {
    try {
      // If no data, show error
      if (!dataArray || !dataArray.length) {
        alert('No data to export');
        return;
      }

      // Create CSV content
      let csvContent = '';

      // Add headers (column names from first object)
      const headers = Object.keys(dataArray[0]);
      csvContent += headers.join(',') + '\r\n';

      // Add data rows
      dataArray.forEach(item => {
        const row = headers.map(header => {
          let cell = item[header] === undefined ? '' : item[header];
          // Escape quotes and wrap fields with commas in quotes
          if (typeof cell === 'string') {
            cell = cell.replace(/"/g, '""');
            if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) {
              cell = `"${cell}"`;
            }
          }
          return cell;
        }).join(',');
        csvContent += row + '\r\n';
      });

      // Create download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);

      link.setAttribute('href', url);
      link.setAttribute('download', filename + '.csv');
      link.style.visibility = 'hidden';

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      // Show success message
      alert('CSV file downloaded successfully! To open in Google Sheets:\n1. Go to sheets.google.com\n2. Create a new spreadsheet\n3. Click File > Import > Upload\n4. Select the CSV file you just downloaded');

    } catch (error) {
      console.error('Error creating CSV:', error);
      alert('An error occurred while creating the CSV file.');
    }
  }
</script>

<style>
  .nav-link {
    @apply px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-md transition-colors;
  }
  .nav-link.active {
    @apply text-blue-600 bg-blue-50;
  }
</style>
